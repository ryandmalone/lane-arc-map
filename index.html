<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lane Arc Map</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; overflow: hidden; }
    #map { position: absolute; inset: 0; }



    

    #status {
      position: absolute; top: 16px; left: 16px;
      background: rgba(255,255,255,0.93); border: 1px solid rgba(0,0,0,0.08);
      border-radius: 10px; padding: 10px 14px; font-size: 11px; color: #555;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12); max-width: 320px; line-height: 1.6;
      white-space: pre-wrap; word-break: break-all;
    }
    #status.ok  { border-color: #1a7a4a33; color: #1a7a4a; }
    #status.err { border-color: #b0002033; color: #b00020; }

    #tooltip {
      display: none; position: fixed; z-index: 999;
      background: rgba(255,255,255,0.98); border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px; padding: 8px 13px; font-size: 12px; color: #333;
      pointer-events: none; line-height: 1.7; box-shadow: 0 2px 12px rgba(0,0,0,0.14);
    }
  </style>

  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js" defer></script>
  <script src="https://unpkg.com/deck.gl@8.9.33/dist.min.js" defer></script>
</head>
<body>

<div id="map"></div>
<div id="tooltip"></div>
<div id="status">‚è≥ Initializing‚Ä¶</div>





<script type="module">
const statusEl = document.getElementById('status');
const setStatus = (msg, cls = '') => { statusEl.textContent = msg; statusEl.className = cls; };

// Wait for deferred scripts
await new Promise(resolve => {
  if (typeof maplibregl !== 'undefined' && typeof deck !== 'undefined') return resolve();
  window.addEventListener('load', resolve, { once: true });
});

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allData = [], months = [], monthIdx = 0, playTimer = null;
let overlay = null, mapReady = false;
let elementUnsub = null;

// ‚îÄ‚îÄ‚îÄ MapLibre ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
  center: [-96, 38], zoom: 3.8, pitch: 30,
});

map.on('load', () => {
  // Use MapboxOverlay ‚Äî the official deck.gl/MapLibre integration
  // It attaches deck.gl as a MapLibre custom layer, sharing the GL context
  // so there's only ONE canvas and NO dark overlay
  overlay = new deck.MapboxOverlay({
    interleaved: false,
    layers: [],
  });
  map.addControl(overlay);
  mapReady = true;
  if (allData.length) renderArcs();
});

// ‚îÄ‚îÄ‚îÄ Sigma Plugin ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let sigmaClient = null;
try {
  const mod = await import('https://esm.sh/@sigmacomputing/plugin@1.0.9');
  sigmaClient = mod.client ?? null;
  if (!sigmaClient) throw new Error('No client export');
  if (typeof sigmaClient.initialize === 'function') sigmaClient.initialize();
  else if (typeof sigmaClient.init === 'function') sigmaClient.init();

  sigmaClient.config.configureEditorPanel([
    { name: 'source',         type: 'element' },
    { name: 'origin_city',    type: 'column', source: 'source', allowMultiple: false },
    { name: 'origin_lat',     type: 'column', source: 'source', allowMultiple: false },
    { name: 'origin_lng',     type: 'column', source: 'source', allowMultiple: false },
    { name: 'dest_city',      type: 'column', source: 'source', allowMultiple: false },
    { name: 'dest_lat',       type: 'column', source: 'source', allowMultiple: false },
    { name: 'dest_lng',       type: 'column', source: 'source', allowMultiple: false },
    { name: 'total_spend',    type: 'column', source: 'source', allowMultiple: false },
    { name: 'shipment_count', type: 'column', source: 'source', allowMultiple: false },
    { name: 'month',          type: 'column', source: 'source', allowMultiple: false },
  ]);

  sigmaClient.config.subscribe(cfg => {
    const elementId = cfg['source'];
    if (!elementId) { setStatus('‚è≥ Select a data source in\nthe editor panel ‚Üí'); return; }
    if (elementUnsub) { try { elementUnsub(); } catch(e){} elementUnsub = null; }
    subscribe(elementId, cfg);
  });

} catch(e) {
  setStatus(`‚ö† Sigma unavailable ‚Äî sample data\n${e.message}`);
  loadSampleData();
}

// ‚îÄ‚îÄ‚îÄ Subscribe ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function subscribe(elementId, cfg) {
  const el = sigmaClient.elements;
  let retried = false;

  const onData = (payload) => {
    if (!payload || Object.keys(payload).length === 0) {
      if (!retried) {
        retried = true;
        setStatus('‚è≥ Waiting for data‚Ä¶');
        setTimeout(() => el.fetchMoreElementData(elementId), 500);
      } else {
        setStatus('‚ö† No data returned from Sigma.', 'err');
      }
      return;
    }
    const rows = Object.fromEntries(Object.entries(payload));
    setStatus('‚úì Data received', 'ok');
    ingestData(cfg, rows);
  };

  try {
    const unsub = el.subscribeToElementData(elementId, onData);
    elementUnsub = typeof unsub === 'function' ? unsub
                 : typeof unsub?.unsubscribe === 'function' ? unsub.unsubscribe.bind(unsub)
                 : () => {};
    setStatus('‚úì Subscribed ‚Äî waiting for data‚Ä¶');
  } catch(e) {
    setStatus(`‚ùå Subscribe failed:\n${e.message}`, 'err');
  }
}

// ‚îÄ‚îÄ‚îÄ Ingest ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ingestData(cfg, rows) {
  const colId = name => cfg[name];
  const latColId = colId('origin_lat');

  if (!latColId || !rows[latColId]?.length) {
    const remapped = Object.fromEntries(
      Object.keys(cfg).filter(k => rows[k]).map(k => [cfg[k], rows[k]])
    );
    if (Object.keys(remapped).length) return ingestData(cfg, remapped);
    setStatus(`‚ö† No data.\nExpected: ${latColId}\nGot: ${Object.keys(rows).slice(0,4).join(', ')}`, 'err');
    return;
  }

  const len = rows[latColId].length;
  allData = [];
  for (let i = 0; i < len; i++) {
    const oLat = parseFloat(rows[colId('origin_lat')]?.[i]);
    const oLng = parseFloat(rows[colId('origin_lng')]?.[i]);
    const dLat = parseFloat(rows[colId('dest_lat')]?.[i]);
    const dLng = parseFloat(rows[colId('dest_lng')]?.[i]);
    if (!isFinite(oLat) || !isFinite(dLat) || !oLat || !dLat) continue;
    allData.push({
      originCity: String(rows[colId('origin_city')]?.[i] ?? ''),
      destCity:   String(rows[colId('dest_city')]?.[i]   ?? ''),
      originLat: oLat, originLng: oLng,
      destLat:   dLat, destLng:   dLng,
      spend:     parseFloat(rows[colId('total_spend')]?.[i])    || 0,
      shipments: parseInt(rows[colId('shipment_count')]?.[i])   || 0,
      month:     fmtMonthKey(rows[colId('month')]?.[i]),
    });
  }

  setStatus(`‚úì ${allData.length} lanes loaded`, 'ok');
  buildTimeline();
}

// ‚îÄ‚îÄ‚îÄ Sample data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadSampleData() {
  const cities = [
    { name: 'Chicago',     lat: 41.88,  lng: -87.63  },
    { name: 'Los Angeles', lat: 34.05,  lng: -118.24 },
    { name: 'Dallas',      lat: 32.78,  lng: -96.80  },
    { name: 'Atlanta',     lat: 33.75,  lng: -84.39  },
    { name: 'New York',    lat: 40.71,  lng: -74.01  },
    { name: 'Seattle',     lat: 47.61,  lng: -122.33 },
    { name: 'Miami',       lat: 25.77,  lng: -80.19  },
    { name: 'Denver',      lat: 39.74,  lng: -104.99 },
  ];
  allData = [];
  ['2024-01','2024-02','2024-03','2024-04','2024-05','2024-06'].forEach(m => {
    cities.forEach((o, i) => cities.forEach((d, j) => {
      if (i === j) return;
      allData.push({ originCity: o.name, destCity: d.name,
        originLat: o.lat, originLng: o.lng, destLat: d.lat, destLng: d.lng,
        spend: Math.random()*800000+20000, shipments: Math.floor(Math.random()*300+5), month: m });
    }));
  });
  setStatus('üìç Sample data active');
  buildTimeline();
}

// ‚îÄ‚îÄ‚îÄ Timeline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildTimeline() {
  if (playTimer) cancelAnimationFrame(playTimer);
  if (mapReady) renderArcs();
}

const LOOP = 3000;
const TRAIL = 2400; // long enough that it never fully fades before restarting

function renderArcs() {
  if (!overlay || !allData.length) return;
  if (playTimer) cancelAnimationFrame(playTimer);

  const maxS = Math.max(...allData.map(r => r.shipments), 1);
  const tip = document.getElementById('tooltip');

  const trips = allData.map((d, i) => ({
    ...d,
    offset: (i / allData.length) * LOOP,
    path: [
      [d.originLng, d.originLat],
      [(d.originLng + d.destLng) / 2,
       (d.originLat + d.destLat) / 2 + Math.hypot(d.destLng - d.originLng, d.destLat - d.originLat) * 0.4],
      [d.destLng, d.destLat],
    ],
    timestamps: [0, LOOP / 2, LOOP],
  }));

  let time = 0;
  function frame() {
    time = (time + 16) % LOOP;

    overlay.setProps({
      layers: [
        new deck.TripsLayer({
          id: 'trips',
          data: trips,
          getPath: d => d.path,
          getTimestamps: d => d.timestamps.map(t => (t + d.offset) % LOOP),
          getColor: [0, 69, 147],
          widthMinPixels: 2,
          getWidth: d => Math.max(1, (d.shipments / maxS) * 5),
          trailLength: TRAIL,
          currentTime: time,
          shadowEnabled: false,
          pickable: true,
          onHover: ({ object, x, y }) => {
            if (object) {
              tip.style.display = 'block';
              tip.style.left = (x+14)+'px'; tip.style.top = (y+14)+'px';
              tip.innerHTML = `<strong>${object.originCity} ‚Üí ${object.destCity}</strong><br>
                Spend: ${fmtMoney(object.spend)}<br>
                Shipments: ${object.shipments.toLocaleString()}`;
            } else tip.style.display = 'none';
          },
        }),
      ]
    });

    playTimer = requestAnimationFrame(frame);
  }

  playTimer = requestAnimationFrame(frame);
}

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtMonthKey(v) {
  if (!v) return '';
  const d = new Date(typeof v === 'number' ? v : Date.parse(v));
  if (isNaN(d)) return String(v);
  return `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}`;
}
function fmtMonth(m) {
  if (!m) return '‚Äî';
  const [y, mo] = m.split('-');
  return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][+mo-1]+' '+y;
}
function fmtMoney(n) {
  return n>=1e6 ? '$'+(n/1e6).toFixed(1)+'M' : n>=1e3 ? '$'+(n/1e3).toFixed(1)+'k' : '$'+n.toFixed(0);
}
</script>
</body>
</html>
