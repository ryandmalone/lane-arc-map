<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lane Arc Map</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #1a1a2e; font-family: 'Inter', sans-serif; overflow: hidden; }
    #map { position: absolute; inset: 0; }
    #deck-canvas { position: absolute; inset: 0; pointer-events: none; }

    #controls {
      position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,0.93); border: 1px solid rgba(0,0,0,0.08);
      border-radius: 12px; padding: 12px 20px; display: flex;
      align-items: center; gap: 16px; min-width: 440px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.18);
    }
    #play-btn {
      width: 36px; height: 36px; border-radius: 50%; border: none;
      background: #1a3a6e; color: #fff; font-size: 15px; cursor: pointer;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    #play-btn:hover { background: #2e6db4; }
    #scrubber-wrap { flex: 1; display: flex; flex-direction: column; gap: 5px; }
    #month-label { font-size: 11px; color: #555; text-align: center; letter-spacing: 0.06em; font-weight: 500; }
    #scrubber {
      -webkit-appearance: none; width: 100%; height: 4px;
      border-radius: 2px; background: rgba(0,0,0,0.12); outline: none; cursor: pointer;
    }
    #scrubber::-webkit-slider-thumb {
      -webkit-appearance: none; width: 14px; height: 14px;
      border-radius: 50%; background: #1a3a6e; cursor: pointer;
    }
    #stats { font-size: 11px; color: #888; text-align: right; flex-shrink: 0; line-height: 1.7; }
    #stats span { color: #222; font-weight: 600; }

    #legend {
      position: absolute; top: 16px; right: 16px;
      background: rgba(255,255,255,0.93); border: 1px solid rgba(0,0,0,0.08);
      border-radius: 10px; padding: 12px 16px; font-size: 11px; color: #666;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12);
    }
    #legend .title { color: #1a1a2e; font-weight: 700; margin-bottom: 8px; font-size: 12px; }
    .lr { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .ll { height: 3px; border-radius: 2px; }

    #status {
      position: absolute; top: 16px; left: 16px;
      background: rgba(255,255,255,0.93); border: 1px solid rgba(0,0,0,0.08);
      border-radius: 10px; padding: 10px 14px; font-size: 11px; color: #555;
      box-shadow: 0 2px 12px rgba(0,0,0,0.12); max-width: 320px; line-height: 1.6;
      white-space: pre-wrap; word-break: break-all;
    }
    #status.ok  { border-color: #1a7a4a33; color: #1a7a4a; }
    #status.err { border-color: #b0002033; color: #b00020; }

    #tooltip {
      display: none; position: fixed; z-index: 999;
      background: rgba(255,255,255,0.98); border: 1px solid rgba(0,0,0,0.1);
      border-radius: 8px; padding: 8px 13px; font-size: 12px; color: #333;
      pointer-events: none; line-height: 1.7; box-shadow: 0 2px 12px rgba(0,0,0,0.14);
    }
  </style>

  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js" defer></script>
  <script src="https://unpkg.com/deck.gl@8.9.33/dist.min.js" defer></script>
</head>
<body>

<div id="map"></div>
<canvas id="deck-canvas"></canvas>
<div id="tooltip"></div>
<div id="status">‚è≥ Initializing‚Ä¶</div>

<div id="legend">
  <div class="title">Spend by Lane</div>
  <div class="lr">
    <div class="ll" style="width:44px;background:linear-gradient(to right,#00c49f,#ffbb28,#ff4d4d)"></div>
    <span>Low ‚Üí High spend</span>
  </div>
  <div class="lr" style="margin-top:4px">
    <div class="ll" style="width:44px;height:2px;background:#aaa"></div>
    <span>Width = shipments</span>
  </div>
</div>

<div id="controls">
  <button id="play-btn">‚ñ∂</button>
  <div id="scrubber-wrap">
    <div id="month-label">‚Äî</div>
    <input type="range" id="scrubber" min="0" value="0" />
  </div>
  <div id="stats">
    Lanes: <span id="stat-lanes">‚Äî</span><br>
    Spend: <span id="stat-spend">‚Äî</span>
  </div>
</div>

<script type="module">
const statusEl = document.getElementById('status');
const setStatus = (msg, cls = '') => { statusEl.textContent = msg; statusEl.className = cls; };

// ‚îÄ‚îÄ‚îÄ Wait for deferred scripts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
await new Promise(resolve => {
  if (typeof maplibregl !== 'undefined' && typeof deck !== 'undefined') return resolve();
  window.addEventListener('load', resolve, { once: true });
});

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let allData = [], months = [], monthIdx = 0;
let playing = false, playTimer = null;
let deckgl = null, mapReady = false;
let elementUnsub = null;
let fetching = false; // guard against duplicate fetchMore calls

// ‚îÄ‚îÄ‚îÄ MapLibre + deck.gl ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
  center: [-96, 38], zoom: 3.8, pitch: 30,
});

map.on('load', () => {
  const canvas = document.getElementById('deck-canvas');
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
  // Use map's existing GL context so deck.gl doesn't spin up its own
  // internal map (which tries to load a mapbox:// style and errors out)
  deckgl = new deck.Deck({
    canvas,
    width: window.innerWidth, height: window.innerHeight,
    initialViewState: getVS(),
    controller: false,
    layers: [],
    onWebGLInitialized: (gl) => { gl.enable(gl.BLEND); },
  });
  map.on('move', () => deckgl?.setProps({ viewState: getVS() }));
  mapReady = true;
  if (allData.length) renderArcs();
});

window.addEventListener('resize', () => {
  const w = window.innerWidth, h = window.innerHeight;
  const c = document.getElementById('deck-canvas');
  c.width = w; c.height = h;
  deckgl?.setProps({ width: w, height: h });
});

function getVS() {
  const c = map.getCenter();
  return { longitude: c.lng, latitude: c.lat, zoom: map.getZoom(),
           pitch: map.getPitch(), bearing: map.getBearing() };
}

// ‚îÄ‚îÄ‚îÄ Sigma Plugin ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let sigmaClient = null;
try {
  const mod = await import('https://esm.sh/@sigmacomputing/plugin@1.0.9');
  sigmaClient = mod.client ?? null;
  if (!sigmaClient) throw new Error('No client export');
  if (typeof sigmaClient.initialize === 'function') sigmaClient.initialize();
  else if (typeof sigmaClient.init === 'function') sigmaClient.init();

  sigmaClient.config.configureEditorPanel([
    { name: 'source',         type: 'element' },
    { name: 'origin_city',    type: 'column', source: 'source', allowMultiple: false },
    { name: 'origin_lat',     type: 'column', source: 'source', allowMultiple: false },
    { name: 'origin_lng',     type: 'column', source: 'source', allowMultiple: false },
    { name: 'dest_city',      type: 'column', source: 'source', allowMultiple: false },
    { name: 'dest_lat',       type: 'column', source: 'source', allowMultiple: false },
    { name: 'dest_lng',       type: 'column', source: 'source', allowMultiple: false },
    { name: 'total_spend',    type: 'column', source: 'source', allowMultiple: false },
    { name: 'shipment_count', type: 'column', source: 'source', allowMultiple: false },
    { name: 'month',          type: 'column', source: 'source', allowMultiple: false },
  ]);

  sigmaClient.config.subscribe(cfg => {
    const elementId = cfg['source'];
    if (!elementId) { setStatus('‚è≥ Select a data source in\nthe editor panel ‚Üí'); return; }
    if (elementUnsub) { try { elementUnsub(); } catch(e){} elementUnsub = null; }
    subscribe(elementId, cfg);
  });

} catch(e) {
  setStatus(`‚ö† Sigma unavailable ‚Äî sample data\n${e.message}`);
  loadSampleData();
}

// ‚îÄ‚îÄ‚îÄ Subscribe ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function subscribe(elementId, cfg) {
  const el = sigmaClient.elements;
  const accRows = {};
  let retried = false;
  fetching = false;

  const onData = (payload) => {
    fetching = false;
    // One-time raw dump so we can see the real shape
    console.log('[ArcMap] raw payload:', JSON.stringify(payload).slice(0, 2000));
    const rows = payload?.rows ?? payload?.data ?? payload?.columns ?? {};
    const hasMore = !!payload?.hasMore;

    // Accumulate columnar arrays keyed by columnId
    for (const [k, vals] of Object.entries(rows)) {
      if (!accRows[k]) accRows[k] = [];
      if (Array.isArray(vals)) accRows[k].push(...vals);
    }

    const rowCount = Object.values(accRows)[0]?.length ?? 0;

    if (hasMore && rowCount > 0) {
      fetching = true;
      setStatus(`‚è≥ Loading‚Ä¶ (${rowCount} rows)`);
      el.fetchMoreElementData(elementId);
    } else {
      // Done ‚Äî remap from columnId keys to what ingestData expects
      // cfg[slotName] = columnId, accRows[columnId] = values[]
      // ingestData resolves cfg[slotName] ‚Üí columnId ‚Üí accRows[columnId]
      // so accRows is already in the right shape ‚Äî just pass it as `rows`
      setStatus('‚úì Data received', 'ok');
      ingestData(cfg, accRows);
    }
  };

  try {
    const unsub = el.subscribeToElementData(elementId, onData);
    elementUnsub = typeof unsub === 'function' ? unsub
                 : typeof unsub?.unsubscribe === 'function' ? unsub.unsubscribe.bind(unsub)
                 : () => {};
    // Delay fetchMore slightly so the subscription is fully registered
    // before we request data ‚Äî calling it immediately causes a 409
    setTimeout(() => el.fetchMoreElementData(elementId), 300);
    setStatus('‚úì Subscribed ‚Äî loading data‚Ä¶');
  } catch(e) {
    setStatus(`‚ùå Subscribe failed:\n${e.message}`, 'err');
  }
}

// ‚îÄ‚îÄ‚îÄ Ingest ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ingestData(cfg, rows) {
  const colId = name => cfg[name];
  const latColId = colId('origin_lat');
  console.log('[ArcMap] ingestData latColId:', latColId, 'rowKeys:', Object.keys(rows).slice(0,5));

  if (!latColId || !rows[latColId]?.length) {
    setStatus(`‚ö† No data.\nExpected colId: ${latColId}\nGot keys: ${Object.keys(rows).slice(0,4).join(', ')}`, 'err');
    return;
  }

  const len = rows[latColId].length;
  allData = [];
  for (let i = 0; i < len; i++) {
    const oLat = parseFloat(rows[colId('origin_lat')]?.[i]);
    const oLng = parseFloat(rows[colId('origin_lng')]?.[i]);
    const dLat = parseFloat(rows[colId('dest_lat')]?.[i]);
    const dLng = parseFloat(rows[colId('dest_lng')]?.[i]);
    if (!isFinite(oLat) || !isFinite(dLat) || !oLat || !dLat) continue;
    allData.push({
      originCity: String(rows[colId('origin_city')]?.[i]    ?? ''),
      destCity:   String(rows[colId('dest_city')]?.[i]      ?? ''),
      originLat: oLat, originLng: oLng,
      destLat:   dLat, destLng:   dLng,
      spend:     parseFloat(rows[colId('total_spend')]?.[i])    || 0,
      shipments: parseInt(rows[colId('shipment_count')]?.[i])   || 0,
      month: fmtMonthKey(rows[colId('month')]?.[i]),
    });
  }

  setStatus(`‚úì ${allData.length} lanes loaded`, 'ok');
  buildTimeline();
}

// ‚îÄ‚îÄ‚îÄ Sample data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loadSampleData() {
  const cities = [
    { name: 'Chicago',     lat: 41.88,  lng: -87.63  },
    { name: 'Los Angeles', lat: 34.05,  lng: -118.24 },
    { name: 'Dallas',      lat: 32.78,  lng: -96.80  },
    { name: 'Atlanta',     lat: 33.75,  lng: -84.39  },
    { name: 'New York',    lat: 40.71,  lng: -74.01  },
    { name: 'Seattle',     lat: 47.61,  lng: -122.33 },
    { name: 'Miami',       lat: 25.77,  lng: -80.19  },
    { name: 'Denver',      lat: 39.74,  lng: -104.99 },
  ];
  allData = [];
  ['2024-01','2024-02','2024-03','2024-04','2024-05','2024-06'].forEach(m => {
    cities.forEach((o, i) => cities.forEach((d, j) => {
      if (i === j) return;
      allData.push({ originCity: o.name, destCity: d.name,
        originLat: o.lat, originLng: o.lng, destLat: d.lat, destLng: d.lng,
        spend: Math.random()*800000+20000, shipments: Math.floor(Math.random()*300+5), month: m });
    }));
  });
  setStatus('üìç Sample data active');
  buildTimeline();
}

// ‚îÄ‚îÄ‚îÄ Timeline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildTimeline() {
  months = [...new Set(allData.map(r => r.month))].filter(Boolean).sort();
  const s = document.getElementById('scrubber');
  s.max = Math.max(0, months.length - 1);
  s.value = monthIdx = 0;
  if (mapReady) renderArcs();
}

// ‚îÄ‚îÄ‚îÄ Color ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spendColor(v, lo, hi) {
  const t = hi > lo ? Math.pow((v - lo) / (hi - lo), 0.4) : 0;
  if (t < 0.5) {
    const s = t * 2;
    return [Math.round(s*255), Math.round(196+s*(187-196)), Math.round(159+s*(40-159)), 210];
  }
  const s = (t - 0.5) * 2;
  return [255, Math.round(187+s*(77-187)), Math.round(40+s*(77-40)), 210];
}

// ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderArcs() {
  if (!deckgl || !months.length) return;
  const m    = months[monthIdx];
  const data = allData.filter(r => r.month === m);
  const spends = data.map(r => r.spend);
  const lo = Math.min(...spends), hi = Math.max(...spends);
  const maxS = Math.max(...data.map(r => r.shipments), 1);

  document.getElementById('month-label').textContent = fmtMonth(m);
  document.getElementById('scrubber').value = monthIdx;
  document.getElementById('stat-lanes').textContent = data.length.toLocaleString();
  document.getElementById('stat-spend').textContent = fmtMoney(data.reduce((a, r) => a + r.spend, 0));

  const tip = document.getElementById('tooltip');
  deckgl.setProps({
    viewState: { ...getVS(), transitionDuration: 0 },
    layers: [new deck.ArcLayer({
      id: 'arcs', data,
      getSourcePosition: d => [d.originLng, d.originLat],
      getTargetPosition: d => [d.destLng,   d.destLat],
      getSourceColor: d => spendColor(d.spend, lo, hi),
      getTargetColor: d => spendColor(d.spend, lo, hi),
      getWidth: d => Math.max(1, (d.shipments / maxS) * 7),
      getHeight: 0.35, pickable: true,
      onHover: ({ object, x, y }) => {
        if (object) {
          tip.style.display = 'block';
          tip.style.left = (x+14)+'px'; tip.style.top = (y+14)+'px';
          tip.innerHTML = `<strong>${object.originCity} ‚Üí ${object.destCity}</strong><br>
            Spend: ${fmtMoney(object.spend)}<br>
            Shipments: ${object.shipments.toLocaleString()}`;
        } else tip.style.display = 'none';
      },
    })]
  });
}

// ‚îÄ‚îÄ‚îÄ Playback ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('play-btn').addEventListener('click', () => {
  playing = !playing;
  document.getElementById('play-btn').textContent = playing ? '‚è∏' : '‚ñ∂';
  if (playing) {
    playTimer = setInterval(() => {
      monthIdx = (monthIdx + 1) % months.length;
      renderArcs();
      if (monthIdx === months.length - 1) {
        playing = false;
        document.getElementById('play-btn').textContent = '‚ñ∂';
        clearInterval(playTimer);
      }
    }, 900);
  } else clearInterval(playTimer);
});

document.getElementById('scrubber').addEventListener('input', e => {
  monthIdx = +e.target.value; renderArcs();
});

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtMonthKey(v) {
  if (!v) return '';
  // Handle Unix ms timestamps (e.g. 1764547200000) or date strings
  const d = new Date(typeof v === 'number' ? v : Date.parse(v));
  if (isNaN(d)) return String(v);
  return `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, '0')}`;
}
function fmtMonth(m) {
  if (!m) return '‚Äî';
  const [y, mo] = m.split('-');
  return ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][+mo-1]+' '+y;
}
function fmtMoney(n) {
  return n>=1e6 ? '$'+(n/1e6).toFixed(1)+'M' : n>=1e3 ? '$'+(n/1e3).toFixed(1)+'k' : '$'+n.toFixed(0);
}
</script>
</body>
</html>
